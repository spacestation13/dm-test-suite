name: BYOND unit tests

on:
  pull_request:
    branches: [master]
  push:
    branches:
      - "master"

jobs:
  unit_test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Add Architecture
        run: |
          sudo dpkg --add-architecture i386
          sudo sed -i'' -E 's/^(deb|deb-src) http:\/\/(azure.archive|security).ubuntu.com/\1 [arch=amd64,i386] http:\/\/\2.ubuntu.com/' /etc/apt/sources.list
          sudo apt-get update

      - name: Install Dependencies
        uses: Eeems-Org/apt-cache-action@v1
        with:
          packages: libssl-dev:i386 libgcc-s1:i386 libcurl4:i386

      - name: Cache BYOND
        uses: actions/cache@v4
        with:
          path: ~/BYOND
          key: ${{ runner.os }}-byond-${{ hashFiles('buildByond.conf')}}
          restore-keys: ${{ runner.os }}-byond

      - name: Setup BYOND
        run: |
          tools/ci/install_byond.sh
          cd $GITHUB_WORKSPACE
          printenv
          echo "BYOND_SYSTEM=/home/runner/BYOND/byond" >> $GITHUB_ENV
          echo "/home/runner/BYOND/byond/bin" >> $GITHUB_PATH
          echo "LD_LIBRARY_PATH=/home/runner/BYOND/byond/bin:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "MANPATH=/home/runner/BYOND/byond/man:$MANPATH" >> $GITHUB_ENV

      - name: Run Full Unit Tests
        id: run_tests
        run: |
          tools/ci/run_unit_tests.sh

      - name: Notify Discord
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          PASSED: ${{ steps.run_tests.outputs.passed }}
          FAILED: ${{ steps.run_tests.outputs.failed }}
          CRASHES: ${{ steps.run_tests.outputs.crashes }}
        run: |
          # Determine embed color and emoji
          if [[ "$FAILED" -eq 0 && "$CRASHES" -eq 0 ]]; then
            COLOR=3066993      # green
            STATUS="✅ All tests passed"
          else
            COLOR=15158332     # red
            STATUS="❌ Some tests failed or crashed"
          fi

          # Read failing tests
          if [ -f summary.log ]; then
            FAILED_TESTS=$(tail -n 10 summary.log)  # show last 10 failed tests
            # Wrap in a code block for formatting
            FAILED_TESTS="\`\`\`\n$FAILED_TESTS\n\`\`\`"
          else
            FAILED_TESTS="No detailed failures recorded."
          fi

          # Build summary description
          DESCRIPTION="$STATUS\nPassed: $PASSED, Failed: $FAILED, Crashes: $CRASHES\n$FAILED_TESTS"

          # Commit/branch info (optional)
          COMMIT_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/commit/$GITHUB_SHA"
          BRANCH="$GITHUB_REF_NAME"

          # Send embed to Discord
          jq -n \
            --arg title "BYOND Unit Test Results" \
            --arg desc "$DESCRIPTION" \
            --arg url "$COMMIT_URL" \
            --arg footer "Branch: $BRANCH" \
            --argjson color "$COLOR" \
            '{embeds: [{title: $title, description: $desc, url: $url, color: $color, footer: {text: $footer}}]}' \
            | curl -H "Content-Type: application/json" \
                  -X POST \
                  -d @- \
                  "$DISCORD_WEBHOOK_URL"